<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Financial Dashboard</title>
<link rel="stylesheet" type="text/css" href="../CSS/styles.css">
</head>
<body>
  <div class="filler">
    <h1><span id="username"></span> </h1>
   
    <div class="balancecontainer">
      <div class="balance-animation"></div>
      <div class="balance-box">
        <span class="balance-text">Your Balance: $</span><span id="balance" class="balance-value"></span>
      </div>
    </div>
  
    <body>
        <a href="template" class="custom-icon">
            <!-- You can use an image or any other HTML element for your custom icon -->
            <img src="../back.jpeg" alt="Custom Icon">
        </a>

</div>
  
<div class="container">
    <div id="transactionContainer" class="transaction-container">
       
    </div>
</div>
<div class="card">
  <div class="card__info">
      <div class="card__logo">MasterCard</div>
        <div class="card__number" id="card-number">
          <span class="card__digit-group">Card Number</span> 
      </div>
      <div class="card__exp-date" id="card-expiry">
          <time datetime="">Expiry Date</time> 
      </div>
        <div id="card-username" class="card__name" aria-label="Dee Stroyer"></div>
        <div class="card__vendor" role="img" aria-labelledby="card-vendor">
        <span id="card-vendor" class="card__vendor-sr">Mastercard</span>
              </div>
</div>
<script src="../JavaScript/personalReport.js">personalReport()</script>
<script>

    window.onload = function() {
        getCookie();
        fetchTransactions();
        dateFormat();
    };

function dateFormat(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function fetchTransactions() {
    //Prepare the headers to all requests   
    const myHeaders = new Headers();
    myHeaders.append("x-auth-token", getCookie("token"));
    myHeaders.append("Content-Type", "application/json");
    console.log("Token", getCookie("token"))
    // Fetch user name
    fetch("http://52.158.43.53:8080/api/users/info", {
        headers: myHeaders
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }
        return response.json(); // Parse response body as JSON
    })
    .then((data) => {
        document.getElementById("username").textContent = data.name
    })
    .catch((error) => console.error(error));

    //Request info
    const raw = "";
    const requestOptions = {
    method: "GET",
    headers: myHeaders,
    // body: raw,
    redirect: "follow"
    };

    //Get current user balance
    fetch("http://52.158.43.53:8080/api/balance/fetch", requestOptions)
    .then((response) => response.text())
    .then((data) => {
        const obj = JSON.parse(data)
        document.getElementById("balance").textContent = obj.Balance
    })
    .catch((error) => console.error(error));

   
    //Get all user transactions
    fetch("http://52.158.43.53:8080/api/transactions/fetch", requestOptions)
    .then((response) => response.text())
    .then((data) => {
        const obj = JSON.parse(data)
        var transactionContainer = document.getElementById("transactionContainer");
        console.log("Obj", obj)
        //Clear existing transactions
        transactionContainer.innerHTML = "";

        obj.forEach(function(transaction) {
            var transactionItem = document.createElement("div");
            transactionItem.classList.add("transaction-item");
            transactionItem.innerHTML = `\
        <span class="title"> ${transaction.RecieverName}</span>
        <div class="transaction-title">ðŸ’µ Price: $${transaction.TransactionAmount}
        </div>  <p class="date">ðŸ“† Purchased On: ${dateFormat(transaction.TransactionDate)}
        <div class="tools">
    <div class="circle">
      <span class="red box"></span>
    </div>
    <div class="circle">
      <span class="yellow box"></span>
    </div>
    <div class="circle">
      <span class="green box"></span>
    </div>
  </div>
</div>
        `;
            transactionContainer.appendChild(transactionItem);
        });

    })
    .catch((error) => console.error(error));

}
</script>                  
     
</body>
</html>
