<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Financial Dashboard</title>
<link rel="stylesheet" type="text/css" href="../CSS/personalReport.css">
</head>
<body>
    <a href="/template" class="custom-icon">
        <!-- You can use an image or any other HTML element for your custom icon -->
        <img src="../back.jpeg" alt="Custom Icon">
    </a>
<div class="header">
    <h1>Welcome, <span id="username"></span>!</h1>
    <h2>Current Balance: $<span id="balance"></span></h2>
    <div id="openModalBtn" class="text-button">set monthy budget</div>
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <input type="text" id="userInput" placeholder="set budget.."> 
            <button id="submitBtn">Submit</button>
            <p id="errorText" class="error-message"></p>
        </div>
    </div>
</div>
<div class="container">
    <h2>Transaction History:</h2>
    <div id="transactionContainer" class="transaction-container">
        <!-- Transaction items will be added dynamically here -->
    </div>
</div>
<script src="../JavaScript/personalReport.js">personalReport()</script>
<script>

    window.onload = function() {
        getCookie();
        fetchTransactions();
        dateFormat();
    };

function dateFormat(dateString) {
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function fetchTransactions() {
    //Prepare the headers to all requests   
    const myHeaders = new Headers();
    myHeaders.append("x-auth-token", getCookie("token"));
    myHeaders.append("Content-Type", "application/json");

    // Fetch user name
    fetch("http://52.158.43.53:8080/api/users/info", {
        headers: myHeaders
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }
        return response.json(); // Parse response body as JSON
    })
    .then((data) => {
        document.getElementById("username").textContent = data.name
    })
    .catch((error) => console.error(error));

    //Request info
    const raw = "";
    const requestOptions = {
    method: "GET",
    headers: myHeaders,
    // body: raw,
    redirect: "follow"
    };

    //Get current user balance
    fetch("http://52.158.43.53:8080/api/balance/fetch", requestOptions)
    .then((response) => response.text())
    .then((data) => {
        const obj = JSON.parse(data)
        document.getElementById("balance").textContent = obj.Balance
    })
    .catch((error) => console.error(error));

   
    //Get all user transactions
    fetch("http://52.158.43.53:8080/api/transactions/fetch", requestOptions)
    .then((response) => response.text())
    .then((data) => {
        const obj = JSON.parse(data)
        var transactionContainer = document.getElementById("transactionContainer");

        //Clear existing transactions
        transactionContainer.innerHTML = "";

        obj.forEach(function(transaction) {
            var transactionItem = document.createElement("div");
            transactionItem.classList.add("transaction-item");
            transactionItem.innerHTML = `
                <p>Date: ${dateFormat(transaction.TransactionDate)}</p>
                <p>Merchant: ${transaction.RecieverName}</p>
                <p>Expenses: $${transaction.TransactionAmount}</p>
            `;
            transactionContainer.appendChild(transactionItem);
        });

    })
    .catch((error) => console.error(error));

}
</script>                  
     
</body>
</html>
